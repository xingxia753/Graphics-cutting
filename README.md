# Graphics-cutting
[第四届中国软件杯比赛项目，矢量图形裁剪](http://www.cnsoftbei.com/bencandy.php?fid=45&aid=1225)

##引言

###开发环境
- 软件开发平台： VS2010
- 软件开发语言： C++
- 软件运行环境：Windows XP、Window7、Windows8
- 测试PC配置：CPU I5-2320 3.GHz，内存4GB，硬盘250GB   


###备注
  本软件采用C++编写，使用附件给出的Demo_ClipView_VC框架，但是为了提高软件的运行速度，减少程序的内存占用，对原有的框架进行了部分更改。因为时间以及其他原因，本设计说明只介绍对原有框架的更改部分以及裁剪算法的具体实现。

##需求概述

      在计算机图形学中，为了描述图形对象，我们必须存储它的全部信息，但有时为了达到分区描述或重点描述某一部分的目的，往往将要描述的部分置于一个窗口内，而将窗口外的部分“剪掉”，这个处理过程叫做裁剪，裁剪在计算机图形处理中具有十分重要的意义。
      该程序能实时高效地计算矢量图形（line、circle）与任意多边形区域（本题特指非矩形的且非自交的凸多边形及凹多边形）的交点，并且判断图形的哪些部分在多边形边界内部，哪些部分在多边形边界外部，同时能正确显示位于多边形边界内部的图形部分，不显示位于多边形边界外部的图形部分。
     为了使用户拥有较好的使用体验，在保证正确的前提下，需要尽可能提升时间和空间效率。 

##详细设计

###算法思路

#### 直线裁剪
   为了加快裁剪速度，减少不必要的计算，首先计算多给多边形的包围盒，如果所给线段在包围盒外，则线段将不会对多边形裁剪，所以可以直接省略。下面将介绍多给线段在多边形包围盒内的情况（即时所给线段位于所给多边形包围盒的内部也有可能不与多边形相交，为了减少计算量，在接下来的计算中也会进行特殊处理）：

 直线裁剪将根据所给线段的斜率分为四种情况进行裁剪：

1.  0<=k<1
2.   1<=k
3.   -1<=k<0
4.    k<=0


 因为这四种情况的处理过程类似（只有第二种情况与其余三种情况在处理过程中有一点例外），本文仅以第一种情况为例，介绍直线裁剪的算法。

 以下图为例
       
多边形ABCDA为所给的多边形，PQ为所给线段
![](http://ww4.sinaimg.cn/large/b00f9334jw1evdqv41pfij20ic0c53zc.jpg)
 
首先以所给多边形所有顶点中最左边的点做竖直的直线做y轴，取所给线段PQ（PQ的延长线）与y轴的交点做水平直线做x轴。做斜率为1，过O点的直线以作参考。

然后对上面的区域进行分区，首先位于PQ逆时针方向的标注为+区，PQ顺时针方向标注为-区，位于PQ线段及延长线上的为0区。
      
标注完以后通过叉积来判断多边形的每个顶点与PQ的相对位置。
      
例如：设顶点A与P组成向量AP
          
 叉积AP*QP>0    AP位于QP的顺时针方向 ->A位于PQ的顺时针方向（+区）
           
叉积AP*QP<0    AP位于QP的逆时针方向 ->A位于PQ的逆时针方向（-区）
           
叉积AP*QP=0    AP与QP重合 ->A位于PQ的顺时针方向（0区）
      
在确定顶点与所给线段的相对位置是，适用于所给线段斜率 :
           
1.     0<=k<1         
2.     -1<k<=0        
3.       k<=-1
当斜率  k>=1时 以上所给例子取反 即：

设顶点A与P组成向量AP

- 叉积AP*QP<0    AP位于QP的顺时针方向 ->A位于PQ的顺时针方向（+区）
- 叉积AP*QP>0    AP位于QP的逆时针方向 ->A位于PQ的逆时针方向（-区）
- 叉积AP*QP=0    AP与QP重合 ->A位于PQ的顺时针方向（0区）


根据以上的判断方法，给所给多边形的顶点进行编码，编码规则如下：
           
1. 位于+区的编码为1
           
2. 位于-区的编码为-1
           
3. 位于0区的编码为0
     
编码之后计算所有顶点的编码和，如果所有顶点的编码和的绝对值等于顶点的总数，则可以判断该线段与多边形也没有任何交点，为了减少计算量，该线段可以直接省略。

如果所有顶点的编码和的绝对值与顶点总数不想等，则可以确定所给线段与多边形一定有交点，接下来的计算将判断每个交点的位置，并根据交点的信息来绘制裁剪后的线段。

   接下来依次计算所给顶点相邻的两个顶点（X、Y）的编码乘积：

1. 乘积等于1则可以判断此相邻的两点位于线段QP的一侧，这两个顶点所确定的线段与QP无交点。（上图的线段AB，线段CD）
2. 乘积等于-1则可以判断顶点X，Y分别位于+、-区，此时计算线段XY(延长线)与线段QP线段（延长线）的交点，判断该交点与线段QP的起点位置的相对关系，并设置一个值记录，这样的交点位于Q点的总数。所有相邻两点判断结束后，判断该记录值得奇偶性，如果为奇数则在最后的绘制过程中需要绘制线段QP的起点Q，否则不用绘制。(上图中的线段AD、线段BC)
3. 乘积等于0时分为两种情况：
     
一个顶点位于线段（延长线）上，一个位于+或者-区：
    
此时需要判断与位于线段（延长线）上的顶点相邻的两个顶点位于线段（延长线的）的同侧或者异侧（利用叉积，在此不再赘述），如果位于同侧，则该店再以后的绘制过程中不会出现，可以省略，否则记录该顶点。
![](http://ww1.sinaimg.cn/large/b00f9334jw1evdr39zqd1j20gy03ydfx.jpg)




     
两个顶点位于线段（延长线）上：

       
如果相邻的两个顶点都位于线段QP(延长线)上，需要判断该两个顶点的凹凸性，如果为凹则需要记录该交点并绘制，如果为凸则不需要记录不进行绘制。

       
判断方法：顺时针或者逆时针的顺序使得交点与其相邻的两个顶点组成两个向量，计算这两个向量的叉积，如果叉积>0 证明该顶点为凹，记录并绘制，叉积<0 证明该顶点为凸，不必记录。

![](http://ww4.sinaimg.cn/large/b00f9334jw1evdr3sz55dj20cp06l0ss.jpg)







当所有需要绘制的点确定之后，将这些顶点存在一个优先级队列中，优先级队列有限规则（点的横坐标小的在前，横坐标相同时，纵坐标绝对值小的在前），按照优先级队列的优先顺序，一次绘制相邻两点的线段，即为裁剪后的线段。      




####圆裁剪

#####A)区域编码的规则及求法

圆与其包围盒的四条边直线将整个平面共划分为十个区域(将圆与其包围盒之间的四个不连续部分视为一个区域)

![](http://ww2.sinaimg.cn/large/b00f9334jw1evdr4eyapkj20dg0aqt95.jpg)
对这十个区域进行五位编码，称为区域编码。编码结构如下:
![](http://ww3.sinaimg.cn/large/b00f9334jw1evdr4riuz8j20jc00xq2z.jpg)

编码规则是，从右往左(从低位到高位)，编码中各位取值如下:

- LEFT：如果当区域位于圆包围盒左边直线的左面(包括左边直线)时，LEFT为1,否则为0。
- RIGHT：当区域位于圆包围盒右边直线的右面(包括右边直线)时，RIGHT为1，否则为0。
- BOTTOM：当区域位于圆包围盒下边直线的下面(包括下边直线)时，BOTTOM为1，否则为0。
- TOP：当区域位于圆包围盒上边直线的上面(包括上边直线)时，TOP为1，否则为0。
- CENTER：当区域位于圆内时，CENTER为1，否则为0。

如上图，各区域的编码，已标明在各自区域之内。图中未标明编码的区域(即圆与其包围盒之间的区域)的编码是00000。

#####B)区域编码的应用

引进多边形顶点的编码，判断多边形是否为完全可见的或显然完全不可见的，就可以对多边形所有顶点的编码施加位与运算来表述，使得判别更为容易。

1. 多边形所有顶点位与运算结果等于16，即所有顶点均位于圆内，此时圆完全不可见。
2. 多边形所有顶点编码的位与运算结果大于0且小于等于8，即整个多边形完全位于圆包围盒外侧，此时圆完全不可见




经过初步筛选，将剩下的圆与多边形的位置关系分为五类

- 第一类位置关系

![](http://ww2.sinaimg.cn/large/b00f9334jw1evdr7szgybj20ce0a0q3b.jpg)
 
边的两个端点者都在圆内，圆与该边无有效交点。

-  第二类位置关系


![](http://ww3.sinaimg.cn/large/b00f9334jw1evdrceknppj20cr0amq3c.jpg)

 
边的两个端点都落在圆的包围盒某条边直线的外侧，圆与该边无有效交点。






-  第三类位置关系

![](http://ww4.sinaimg.cn/large/b00f9334jw1evdr87prctj20cz09ugm1.jpg)
 
边的一个端点落在圆内，另一个端点落在圆外，此时圆与该边有一个有效交点。

-  第四类位置关系
 

![](http://ww4.sinaimg.cn/large/b00f9334jw1evdr8m77cbj20cg0araai.jpg)
边的两个端点分别落在相对的两个区域(即在包围盒外面且无论按逆时针还是按顺时针都相隔三个区域的两个区域)内，此时圆与该边至多有2个交点。







-  第五类位置关系

![](http://ww3.sinaimg.cn/large/b00f9334jw1evdr8wi3xhj20ct0a4dgb.jpg)
 
其它的所有情形皆归为此类,称这样的边为第五类边,这类边的共同特点是两个端点均在圆的外面。这一类又分两种情形一种是和圆有0个交点即无交点,和圆相切的边也归为此类的边,另一类是和圆有个交点的边。

设多边形某边（顺时针方向）端点分别为v1、v2，其区域编码分别为code1、code2
针对第一、第二、第三、第四类位置关系，可用区域编码直接判别

1. 第一类：code1 & code2 = 16。
2. 第二类：0 < code1 & code2 <= 8。
3. 第三类：code1 | code2  >= 16 且 code1 & code2 != 16；
4. 第四类：code1 | code2 = 3 或 code1 | code2 = 12 或 code1 | code2 = 15；

针对第五类位置关系的判定
 
![](http://ww1.sinaimg.cn/large/b00f9334jw1evdredqv9bj20e70asaaf.jpg)

设圆心为(Xc,Yc),半径为R，边为P0、P1，两个端点到圆心的分别为d0和d1，圆心到直线的距离为d，过圆心作直线l垂直于直线P0P1。

1. 如果d >= R ，那么P0P1位于圆外（相切）
2. 如果d <  R，且d0 <= R，d1 <= R,那么P0P1位于圆内
3. 如果d <  R，且（d0 - R）*（d1 - R），那么P0P1的一个端点在圆内，一个在圆外，此时圆与直线有一个交点。
4. 如果d <  R，且d0 >= R,d1 >= R,而且P0P1两个端点都处于直线l同侧，此时圆与直线无交点。
5. 如果d <  R，且d0 >= R,d1 >= R,而且P0P1两个端点都处于直线l异侧，此时圆与直线有两个交点。


#####C)绘制圆弧

首先规定沿圆顺时针方向进入多边形的交点为入点，离开多边形的交点为出点。

将B）部分所求得交点按照顺时针顺序依次放入交点数组里面。

- 若无交点，则判断圆心是否位于多边形边界内部，如果是，则说明圆位于边界内部，画出整个圆，反之，则在外部

- 若交点数组不为空，则需要找到第一个入点，然后依次取两个点绘制圆弧，直到所有交点被取出。

####3.2 对原有框架的修改
修改了DrawLine，DrawCircle，DrawTestCase等三个函数，使其采用类似双缓冲的机制，将内容画到内存DC中，最后贴图于ClientDC中，提高绘图效率。


  

     




                     
   









































